<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>6.S081_Lab10_Mmap | lzx's Blog</title><meta name="author" content="lzx"><meta name="copyright" content="lzx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="6.S081_Lab10_Mmap 写在前面 如果一行代码都还没有写，不知道完全要在哪里写，写什么东西，说明是对xv6的相关机制不懂，继续反复阅读xv6book 如果是写了一些代码，但是运行不起来，或者运行情况与预期不符，可以尝试询问AI或者用gdb逐行调试 如果已经花费了超额时间（例如easy题目仅做题时间超过1.5h），可以尝试阅读别人的源码，但是一定不要边看边写，要彻底看懂后自己完整的敲出来">
<meta property="og:type" content="article">
<meta property="og:title" content="6.S081_Lab10_Mmap">
<meta property="og:url" content="https://taffy128.github.io/2025/11/28/6-S081-Lab10-Mmap/index.html">
<meta property="og:site_name" content="lzx&#39;s Blog">
<meta property="og:description" content="6.S081_Lab10_Mmap 写在前面 如果一行代码都还没有写，不知道完全要在哪里写，写什么东西，说明是对xv6的相关机制不懂，继续反复阅读xv6book 如果是写了一些代码，但是运行不起来，或者运行情况与预期不符，可以尝试询问AI或者用gdb逐行调试 如果已经花费了超额时间（例如easy题目仅做题时间超过1.5h），可以尝试阅读别人的源码，但是一定不要边看边写，要彻底看懂后自己完整的敲出来">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://taffy128.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2025-11-28T10:43:14.371Z">
<meta property="article:modified_time" content="2025-11-28T10:45:03.711Z">
<meta property="article:author" content="lzx">
<meta property="article:tag" content="C++学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://taffy128.github.io/img/avatar.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "6.S081_Lab10_Mmap",
  "url": "https://taffy128.github.io/2025/11/28/6-S081-Lab10-Mmap/",
  "image": "https://taffy128.github.io/img/avatar.jpg",
  "datePublished": "2025-11-28T10:43:14.371Z",
  "dateModified": "2025-11-28T10:45:03.711Z",
  "author": [
    {
      "@type": "Person",
      "name": "lzx",
      "url": "https://taffy128.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://taffy128.github.io/2025/11/28/6-S081-Lab10-Mmap/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '6.S081_Lab10_Mmap',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-color: #FFB6C1;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">22</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fas fa-folder-open"></i><span> 分类</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/CS%20106L/"><span> CS 106L</span></a></li><li><a class="site-page child" href="/categories/%E5%86%85%E5%AD%98%E6%B1%A0/"><span> 内存池</span></a></li><li><a class="site-page child" href="/categories/6-S081/"><span> 6.S081</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">lzx's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">6.S081_Lab10_Mmap</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fas fa-folder-open"></i><span> 分类</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/CS%20106L/"><span> CS 106L</span></a></li><li><a class="site-page child" href="/categories/%E5%86%85%E5%AD%98%E6%B1%A0/"><span> 内存池</span></a></li><li><a class="site-page child" href="/categories/6-S081/"><span> 6.S081</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">6.S081_Lab10_Mmap</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-11-28T10:43:14.371Z" title="发表于 2025-11-28 18:43:14">2025-11-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-11-28T10:45:03.711Z" title="更新于 2025-11-28 18:45:03">2025-11-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/6-S081/">6.S081</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1>6.S081_Lab10_Mmap</h1>
<h2 id="写在前面">写在前面</h2>
<p>如果一行代码都还没有写，不知道完全要在哪里写，写什么东西，说明是对xv6的相关机制不懂，继续反复阅读<a target="_blank" rel="noopener" href="https://th0ar.gitbooks.io/xv6-chinese/content/index.html">xv6book</a></p>
<p>如果是写了一些代码，但是运行不起来，或者运行情况与预期不符，可以尝试询问AI或者用gdb逐行调试</p>
<p>如果已经花费了超额时间（例如easy题目仅做题时间超过1.5h），可以尝试阅读别人的源码，<strong>但是一定不要边看边写，要彻底看懂后自己完整的敲出来</strong></p>
<p><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2021/labs/mmap.html">Lab10地址</a> <a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2021/schedule.html">课程首页</a></p>
<h2 id="Lab10">Lab10</h2>
<h3 id="核心数据结构">核心数据结构</h3>
<p>实现 mmap 的核心数据结构是 Linux 中的 <code>vm_area_struct</code>，下面是 CSAPP 的经典好图：</p>
<p><img src="/images/6.S081Lab10-1.png" alt></p>
<p>start 和 end 是一个左闭右开的区间，即 <code>[start, end)</code></p>
<p>在 Linux 内核中，VMA 是通过红黑树以起始地址为关键字来实现快速增删改查的，在这个 Lab 实现中，我就用单链表来把 VMA 串一起就行了，因此 <code>struct vma</code> 的定义如下：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct vma &#123;</span><br><span class="line">  uint64 start;</span><br><span class="line">  uint64 end;</span><br><span class="line">  <span class="keyword">int</span> prot;</span><br><span class="line">  <span class="keyword">int</span> flags;</span><br><span class="line">  struct file *f;</span><br><span class="line">  uint64 offset;</span><br><span class="line">  struct vma *<span class="keyword">next</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们把这个 VMA 以 <code>struct vma *vma;</code> 的形式嵌入到 <code>struct proc</code> 结构中。</p>
<p>在 Xv6 中，用户地址空间如下图所示，考虑将 <code>unused</code> 地址空间划给 <code>mmap</code> 使用，</p>
<p><img src="/images/6.S081Lab10-2.png" alt></p>
<p>在我的实现中，我将 mmap 后的虚拟地址空间划定在 <code>trapframe</code> 之下（空一个页），即令 <code>TRAPFRAME - PGSIZE</code> 为 mmap 后的最高地址空间，<strong>mmap 的地址空间由此向下生长</strong>。</p>
<p>在 <code>memlayout.h</code> 中定义，</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define MAXVMEMMAP (TRAPFRAME - PGSIZE)</span></span><br></pre></td></tr></table></figure>
<h3 id="添加-syscall">添加 syscall</h3>
<p>在 <code>usys.pl</code> 中添加：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">entry(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">entry(<span class="string">&quot;munmap&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>在 <code>user.h</code> 中添加：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">mmap</span><span class="params">(<span class="type">void</span>*, <span class="type">size_t</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">off_t</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">munmap</span><span class="params">(<span class="type">void</span>*, <span class="type">size_t</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>在 <code>syscall.c</code> 中，添加 prototype，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> uint64 <span class="title function_">sys_mmap</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> uint64 <span class="title function_">sys_munmap</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>并完善 <code>syscalls[]</code> 函数指针数组：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// An array mapping syscall numbers from syscall.h</span></span><br><span class="line"><span class="comment">// to the function that handles the system call.</span></span><br><span class="line"><span class="type">static</span> <span class="title function_">uint64</span> <span class="params">(*syscalls[])</span><span class="params">(<span class="type">void</span>)</span> = &#123;</span><br><span class="line">[SYS_fork]    sys_fork,</span><br><span class="line">[SYS_exit]    sys_exit,</span><br><span class="line">[SYS_wait]    sys_wait,</span><br><span class="line">[SYS_pipe]    sys_pipe,</span><br><span class="line">[SYS_read]    sys_read,</span><br><span class="line">[SYS_kill]    sys_kill,</span><br><span class="line">[SYS_exec]    sys_exec,</span><br><span class="line">[SYS_fstat]   sys_fstat,</span><br><span class="line">[SYS_chdir]   sys_chdir,</span><br><span class="line">[SYS_dup]     sys_dup,</span><br><span class="line">[SYS_getpid]  sys_getpid,</span><br><span class="line">[SYS_sbrk]    sys_sbrk,</span><br><span class="line">[SYS_sleep]   sys_sleep,</span><br><span class="line">[SYS_uptime]  sys_uptime,</span><br><span class="line">[SYS_open]    sys_open,</span><br><span class="line">[SYS_write]   sys_write,</span><br><span class="line">[SYS_mknod]   sys_mknod,</span><br><span class="line">[SYS_unlink]  sys_unlink,</span><br><span class="line">[SYS_link]    sys_link,</span><br><span class="line">[SYS_mkdir]   sys_mkdir,</span><br><span class="line">[SYS_close]   sys_close,</span><br><span class="line">[SYS_mmap]    sys_mmap,</span><br><span class="line">[SYS_munmap]  sys_munmap,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="VMA-的分配与释放">VMA 的分配与释放</h3>
<p>需要自己实现一个 VMA 的分配与释放，这部分的实现和 <code>kalloc/kfree</code> 类似。</p>
<p>在 Hint 里已经提示了 <code>A size of 16 should be sufficient</code>，因此我们在 <code>param.h</code> 中定义，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NVMA         16  <span class="comment">// maximum number of virtual memory areas</span></span></span><br></pre></td></tr></table></figure>
<p>然后在 <code>proc.c</code> 中定义一个 VMA 对象的 pool，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> _<span class="title">vma</span>[<span class="title">NVMA</span>];</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> *<span class="title">free_vma_list</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">&#125; vma;</span><br></pre></td></tr></table></figure>
<p>然后编写 <code>allocvma</code> 和 <code>freevma</code> 的代码，</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">struct vma *</span><br><span class="line">allocvma(void) &#123;</span><br><span class="line">  struct vma *v;</span><br><span class="line"> </span><br><span class="line">  acquire(&amp;vma.lock);</span><br><span class="line">  v = vma.free_vma_list;</span><br><span class="line">  <span class="keyword">if</span> (v)</span><br><span class="line">    vma.free_vma_list = v-&gt;<span class="keyword">next</span>;</span><br><span class="line">  release(&amp;vma.lock);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">void</span><br><span class="line">freevma(struct vma *v) &#123;</span><br><span class="line">  acquire(&amp;vma.lock);</span><br><span class="line">  v-&gt;<span class="keyword">next</span> = vma.free_vma_list;</span><br><span class="line">  vma.free_vma_list = v;</span><br><span class="line">  release(&amp;vma.lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现-mmap-函数">实现 mmap 函数</h3>
<p>切换到内核态后，需要先对用户传入的参数作校验。有几点需要注意：</p>
<ol>
<li>用户可以 mmap 一个文件并写入，写入后使文件的 size 增大，因此 mmap 的范围可以超过当前文件的 size</li>
<li>如果文件没有写入权限，且是 <code>MAP_SHARED</code>，则不允许</li>
<li>如果文件没有写入权限，且是 <code>MAP_PRIVATE</code>，则允许</li>
</ol>
<p>最后我们将这些参数转发到 mmap 主体逻辑实现。（Note：这么写是因为写到后面 fork 的时候才更改的代码结构，这样会更加方便代码复用，以及上面提到的注意点也是后来测试的时候才逐渐学习到的）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_mmap</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="comment">// void *mmap(void *addr, size_t len, int prot, int flags,</span></span><br><span class="line">  <span class="comment">//            int fd, off_t offset);</span></span><br><span class="line">  <span class="comment">// we assume both addr and offset are 0, so we won&#x27;t use them </span></span><br><span class="line">  <span class="type">size_t</span> len;</span><br><span class="line">  <span class="type">int</span> prot, flags;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"> </span><br><span class="line">  argaddr(<span class="number">1</span>, &amp;len);</span><br><span class="line">  argint(<span class="number">2</span>, &amp;prot);</span><br><span class="line">  argint(<span class="number">3</span>, &amp;flags);</span><br><span class="line">  <span class="keyword">if</span> (argfd(<span class="number">4</span>, <span class="number">0</span>, &amp;f) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (flags == <span class="number">0</span> || ((flags &amp; MAP_PRIVATE) &amp;&amp; (flags &amp; MAP_SHARED))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (f-&gt;type != FD_INODE || f-&gt;ip-&gt;type != T_FILE </span><br><span class="line">      || len == <span class="number">0</span>) &#123; <span class="comment">// len &gt; f-&gt;ip-&gt;size is allowed</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (((prot &amp; PROT_READ) &amp;&amp; !f-&gt;readable) || </span><br><span class="line">      ((prot &amp; PROT_WRITE) &amp;&amp; !f-&gt;writable &amp;&amp; !(flags &amp; MAP_PRIVATE))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> mmap(p, <span class="number">0</span>, len, prot, flags, f, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是 mmap 的主体逻辑实现。当时比较纠结的地方在于，用户态传入的 len 如果不是 page-aligned 的该怎么处理才是正确的，尤其是 munmap 的时候，如果 munmap 的起始地址不是 page-aligend 的该怎么办？实际上在 <code>man 2 munmap</code> 可以看到，<strong>munmap 的 addr 必须是 page-aligned，但是 length 却可以不用</strong>。不过好在我查看了 <code>mmaptest.c</code>，测试时所有调用的起始地址和长度都是 page-aligned 的，实现的时候不用担心由于地址不对齐而产生 UB 行为（不知道该怎么实现才是正确的）。</p>
<p>在实现 <code>mmap</code> 的时候，首先新分配一个 VMA，填入相应的字段，然后把这段虚拟地址通过 <code>mappages</code> 映射到用户地址空间，注意，这里的页表权限仅仅设置 <code>PTE_U</code>，以方便后面通过 page-fault 来处理这些 mmap 后的页。最后通过 filedup 来增加文件指针引用，防止文件指针在 <code>close</code> 后被释放。</p>
<p>mmap 的主题逻辑实现代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">mmap</span><span class="params">(<span class="keyword">struct</span> proc *p, uint64 addr, <span class="type">size_t</span> len, <span class="type">int</span> prot, <span class="type">int</span> flags, </span></span><br><span class="line"><span class="params">     <span class="keyword">struct</span> file *f, <span class="type">off_t</span> offset)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> *<span class="title">vma</span>;</span></span><br><span class="line">  <span class="type">size_t</span> len_aligned;</span><br><span class="line"> </span><br><span class="line">  vma = allocvma();</span><br><span class="line">  <span class="keyword">if</span> (vma == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  len_aligned = PGROUNDUP(len);</span><br><span class="line">  <span class="keyword">if</span> (addr == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;vma == <span class="number">0</span>) &#123;</span><br><span class="line">      vma-&gt;end = MAXVMEMMAP;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vma-&gt;end = p-&gt;vma-&gt;start;</span><br><span class="line">    &#125;</span><br><span class="line">    vma-&gt;start = vma-&gt;end - len_aligned;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    vma-&gt;start = addr;  </span><br><span class="line">    vma-&gt;end = addr + len_aligned;</span><br><span class="line">  &#125;</span><br><span class="line">  vma-&gt;flags = flags;</span><br><span class="line">  vma-&gt;prot = prot;</span><br><span class="line">  vma-&gt;f = f;</span><br><span class="line">  vma-&gt;offset = offset;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">for</span> (addr = vma-&gt;start; addr &lt; vma-&gt;end; addr += PGSIZE) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mappages(p-&gt;pagetable, addr, PGSIZE, <span class="number">0</span>, PTE_U) != <span class="number">0</span>) &#123;</span><br><span class="line">      freevma(vma);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  vma-&gt;next = p-&gt;vma;</span><br><span class="line">  p-&gt;vma = vma;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// duplicate the file descriptor so that </span></span><br><span class="line">  <span class="comment">// the structure doesn&#x27;t disappear when the file is closed</span></span><br><span class="line">  filedup(f);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> vma-&gt;start;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Page-fault-处理">Page fault 处理</h3>
<p>Page fault 这块的处理与 COW fork 有异曲同工之妙，这部分可以去参考一下之前 COW fork lab 的写法，代码结构也可以模仿一下。</p>
<p>在 trap 中，我们先进行一些条件判断这是不是一个合法的因为 mmap 而产生的 page fault，拿到这个 PA 对应的 PTE，然后循环遍历 proc 的 VMA 链表，找到对应的 vma，接下来的逻辑交给 <code>do_mmap_page</code> 来处理。</p>
<p>因此 <code>usertrap</code> 改动后的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// handle an interrupt, exception, or system call from user space.</span></span><br><span class="line"><span class="comment">// called from trampoline.S</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">usertrap</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  uint64 scause;</span><br><span class="line">  uint64 va, pa;</span><br><span class="line">  <span class="type">pte_t</span> *pte;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> *<span class="title">vma</span> =</span> <span class="number">0</span>, *iter;</span><br><span class="line">  <span class="type">int</span> which_dev = <span class="number">0</span>, rc;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span>((r_sstatus() &amp; SSTATUS_SPP) != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;usertrap: not from user mode&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// send interrupts and exceptions to kerneltrap(),</span></span><br><span class="line">  <span class="comment">// since we&#x27;re now in the kernel.</span></span><br><span class="line">  w_stvec((uint64)kernelvec);</span><br><span class="line"> </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// save user program counter.</span></span><br><span class="line">  p-&gt;trapframe-&gt;epc = r_sepc();</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span>((scause = r_scause()) == <span class="number">8</span>)&#123;</span><br><span class="line">    <span class="comment">// system call</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(killed(p))</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// sepc points to the ecall instruction,</span></span><br><span class="line">    <span class="comment">// but we want to return to the next instruction.</span></span><br><span class="line">    p-&gt;trapframe-&gt;epc += <span class="number">4</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// an interrupt will change sepc, scause, and sstatus,</span></span><br><span class="line">    <span class="comment">// so enable only now that we&#x27;re done with those registers.</span></span><br><span class="line">    intr_on();</span><br><span class="line"> </span><br><span class="line">    syscall();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>((which_dev = devintr()) != <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">// ok</span></span><br><span class="line">  &#125; <span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> (scause == <span class="number">12</span> || scause == <span class="number">13</span> || scause == <span class="number">15</span>) &#123;</span><br><span class="line">    <span class="comment">// instruction/load/store/AMO page fault</span></span><br><span class="line"> </span><br><span class="line">    va = r_stval();</span><br><span class="line">    <span class="keyword">if</span> (va &gt;= MAXVA)</span><br><span class="line">      <span class="keyword">goto</span> KILL;</span><br><span class="line"> </span><br><span class="line">    va = PGROUNDDOWN(va);</span><br><span class="line">    pte = walk(p-&gt;pagetable, va, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!pte)    <span class="comment">// no page table entry for va</span></span><br><span class="line">      <span class="keyword">goto</span> KILL;</span><br><span class="line"> </span><br><span class="line">    pa = PTE2PA(*pte);</span><br><span class="line">    <span class="keyword">if</span> (pa != <span class="number">0</span>) <span class="comment">// page access permission denied</span></span><br><span class="line">      <span class="keyword">goto</span> KILL;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> (iter = p-&gt;vma; iter; iter = iter-&gt;next) &#123;</span><br><span class="line">      <span class="keyword">if</span> (va &gt;= iter-&gt;start &amp;&amp; va &lt; iter-&gt;end) &#123;</span><br><span class="line">        vma = iter;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!vma) <span class="comment">// va is out of mmap-ed range</span></span><br><span class="line">      <span class="keyword">goto</span> KILL;</span><br><span class="line"> </span><br><span class="line">    rc = do_mmap_page(vma, va, pte);</span><br><span class="line">    <span class="keyword">if</span> (rc != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;do_mmap_page failed: %d\n&quot;</span>, rc);</span><br><span class="line">      <span class="keyword">goto</span> KILL;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  KILL:</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;usertrap(): unexpected scause %p pid=%d\n&quot;</span>, r_scause(), p-&gt;pid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;            sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());</span><br><span class="line">    setkilled(p);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span>(killed(p))</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// give up the CPU if this is a timer interrupt.</span></span><br><span class="line">  <span class="keyword">if</span>(which_dev == <span class="number">2</span>)</span><br><span class="line">    yield();</span><br><span class="line"> </span><br><span class="line">  usertrapret();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>do_mmap_page</code> 中，我们计算出正确的 offset，从文件里读取出这片页。注意：如果文件大小不够，剩余的长度部分需要 <code>zero-fill</code>。最后更改页表项，把这片页映射到页表里。实现代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">do_mmap_page</span><span class="params">(<span class="keyword">struct</span> vma *vma, uint64 addr, <span class="type">pte_t</span> *pte)</span> &#123;</span><br><span class="line">  <span class="type">char</span> *mem;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span>;</span></span><br><span class="line">  <span class="type">off_t</span> offset;</span><br><span class="line">  uint64 pte_flags;</span><br><span class="line">  <span class="type">int</span> rc;</span><br><span class="line"> </span><br><span class="line">  mem = kalloc();</span><br><span class="line">  <span class="keyword">if</span> (mem == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  f = vma-&gt;f;</span><br><span class="line">  offset = vma-&gt;offset + (addr - vma-&gt;start);</span><br><span class="line">  ilock(f-&gt;ip);</span><br><span class="line">  <span class="keyword">if</span> ((rc = readi(f-&gt;ip, <span class="number">0</span>, (uint64)mem, offset, PGSIZE)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    iunlock(f-&gt;ip);</span><br><span class="line">    kfree(mem);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  iunlock(f-&gt;ip);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// zero-fill the rest of the page</span></span><br><span class="line">  <span class="keyword">if</span> (rc &lt; PGSIZE) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(mem + rc, <span class="number">0</span>, PGSIZE - rc);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  pte_flags = PTE_FLAGS(*pte);</span><br><span class="line">  pte_flags |= (vma-&gt;prot &amp; PROT_RWX_MASK) &lt;&lt; <span class="number">1</span>;</span><br><span class="line">  *pte = PA2PTE((uint64)mem) | pte_flags;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现-munmap-函数">实现 munmap 函数</h3>
<p>先处理用户态传入的参数，这里就要求了 <code>addr</code> 必须是 page-aligned 了。然后转发到 <code>munmap</code> 逻辑处理，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_munmap</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  uint64 addr, start, end;</span><br><span class="line">  <span class="type">size_t</span> len;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"> </span><br><span class="line">  argaddr(<span class="number">0</span>, &amp;addr); <span class="comment">// addr is page-aligned</span></span><br><span class="line">  argaddr(<span class="number">1</span>, &amp;len);</span><br><span class="line">  <span class="keyword">if</span> (addr % PGSIZE) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  start = addr;</span><br><span class="line">  end = PGROUNDUP(addr + len);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> munmap(p, start, end);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>munmap</code> 的主体逻辑实现就要复杂一些了，因为这里的一个难点涉及到单链表的一边遍历一边删除。Lab 文档已经保证了，unmap 的区间满足如下条件：</p>
<blockquote>
<p>either unmap at the start, or at the end, or the whole region (but not punch a hole in the middle of a region)</p>
</blockquote>
<p>翻译过来就是，只会 unmap 开头的一段区间或者结尾的一段区间，总之不会从区间中间打洞。</p>
<p>这部分需要循环遍历 VMA 单链表，计算出当前处理的地址区间 [l, r)，如果是 <code>MAP_SHARED</code>，则调用 <code>writeback</code> 写回文件，接着调用 <code>uvmunmap</code> 解除映射，最后根据当前是哪一种情况（开头部分、结尾部分、整个区间）来修改 VMA。</p>
<p>代码实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">munmap</span><span class="params">(<span class="keyword">struct</span> proc *p, uint64 start, uint64 end)</span> &#123;</span><br><span class="line">  uint64 addr, l, r, flags;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vma</span> *<span class="title">iter</span>, *<span class="title">iter2</span>, *<span class="title">prev</span> =</span> <span class="number">0</span>;</span><br><span class="line">  <span class="type">pte_t</span> *pte;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">for</span> (iter = p-&gt;vma; iter;) &#123;</span><br><span class="line">    l = max(start, iter-&gt;start);</span><br><span class="line">    r = min(end, iter-&gt;end);</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= r) &#123;</span><br><span class="line">      prev = iter;</span><br><span class="line">      iter = iter-&gt;next;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (iter-&gt;flags &amp; MAP_SHARED) &#123;</span><br><span class="line">      begin_op();</span><br><span class="line">      <span class="keyword">for</span> (addr = l; addr &lt; r; addr += PGSIZE) &#123;</span><br><span class="line">        pte = walk(p-&gt;pagetable, addr, <span class="number">0</span>);</span><br><span class="line">        flags = PTE_FLAGS(*pte);</span><br><span class="line">        <span class="keyword">if</span> (flags &amp; PTE_D) &#123;</span><br><span class="line">          <span class="keyword">if</span> (writeback(iter-&gt;f, iter-&gt;offset + addr - iter-&gt;start, addr, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            end_op();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      end_op();</span><br><span class="line">    &#125;</span><br><span class="line">    uvmunmap(p-&gt;pagetable, l, (r - l) / PGSIZE, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (l == iter-&gt;start &amp;&amp; r == iter-&gt;end) &#123;</span><br><span class="line">      fileclose(iter-&gt;f);</span><br><span class="line">      <span class="keyword">if</span> (prev) &#123;</span><br><span class="line">        prev-&gt;next = iter-&gt;next;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        p-&gt;vma = iter-&gt;next;</span><br><span class="line">      &#125;</span><br><span class="line">      iter2 = iter;</span><br><span class="line">      iter = iter-&gt;next;</span><br><span class="line">      freevma(iter2);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (l == iter-&gt;start) &#123;</span><br><span class="line">        iter-&gt;offset += r - l;</span><br><span class="line">        iter-&gt;start = r;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r == iter-&gt;end) &#123;</span><br><span class="line">        iter-&gt;end = l;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        panic(<span class="string">&quot;munmap: punch a hole in the middle of a region&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      prev = iter;</span><br><span class="line">      iter = iter-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="文件写回-writeback-实现">文件写回 writeback 实现</h3>
<p>这部分的实现可以参照 <code>filewrite</code>，但需要注意的是，在 mmap 的写回时不能更改 <code>f-&gt;off</code>。代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Write back pages to file f.</span></span><br><span class="line"><span class="comment">// addr is a kernel address.</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">writeback</span><span class="params">(<span class="keyword">struct</span> file *f, <span class="type">off_t</span> off, uint64 addr, <span class="type">int</span> nr_page)</span> &#123;</span><br><span class="line">  <span class="type">int</span> r, ret = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span>(f-&gt;writable == <span class="number">0</span> || f-&gt;type != FD_INODE)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// write a few blocks at a time to avoid exceeding</span></span><br><span class="line">  <span class="comment">// the maximum log transaction size, including</span></span><br><span class="line">  <span class="comment">// i-node, indirect block, allocation blocks,</span></span><br><span class="line">  <span class="comment">// and 2 blocks of slop for non-aligned writes.</span></span><br><span class="line">  <span class="comment">// this really belongs lower down, since writei()</span></span><br><span class="line">  <span class="comment">// might be writing a device like the console.</span></span><br><span class="line">  <span class="type">int</span> max = ((MAXOPBLOCKS<span class="number">-1</span><span class="number">-1</span><span class="number">-2</span>) / <span class="number">2</span>) * BSIZE;</span><br><span class="line">  <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">  n = nr_page * PGSIZE;</span><br><span class="line">  <span class="keyword">while</span> (i &lt; n) &#123;</span><br><span class="line">    <span class="type">int</span> n1 = n - i;</span><br><span class="line">    <span class="keyword">if</span> (n1 &gt; max)</span><br><span class="line">      n1 = max;</span><br><span class="line"> </span><br><span class="line">    begin_op();</span><br><span class="line">    ilock(f-&gt;ip);</span><br><span class="line">    <span class="keyword">if</span> ((r = writei(f-&gt;ip, <span class="number">1</span>, addr + i, off, n1)) &gt; <span class="number">0</span>)</span><br><span class="line">      off += r;</span><br><span class="line">    iunlock(f-&gt;ip);</span><br><span class="line">    end_op();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(r != n1)&#123;</span><br><span class="line">      <span class="comment">// error from writei</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    i += r;</span><br><span class="line">  &#125;</span><br><span class="line">  ret = (i == n ? n : <span class="number">-1</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Exit-部分处理">Exit 部分处理</h3>
<p>有了我们之前的接口设计，<code>exit</code> 处理就非常简单了，只需要在 <code>exit</code> 中添加如下代码即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// unmap the process&#x27;s mapped regions</span></span><br><span class="line"><span class="keyword">if</span> (p-&gt;vma)</span><br><span class="line">  munmap(p, p-&gt;vma-&gt;start, MAXVMEMMAP);</span><br></pre></td></tr></table></figure>
<h3 id="Fork-部分处理">Fork 部分处理</h3>
<p>在 <code>fork</code> 的时候，依次遍历父亲进程的 VMA 链表，将每一块区域都调用 <code>mmap</code> 到子进程中。这样就完了吗？不，<strong>由于 VMA 是每次插入链表的头部，链表尾部的映射地址最高，链表头部的映射地址最低</strong>（这条性质也是我们需要维护的，读者可以结合 <code>mmap</code> 思考为什么），因此我们应该<strong>反向遍历</strong>父亲进程的链表，这样才能让子进程完全模拟<code>mmap</code> 整个过程，映射后无论是地址空间还是 VMA 链表的顺序都会和父进程一致。但是由于我的实现采用了单链表设计，因此在这里映射完成后需要<strong>反转链表</strong>。</p>
<p>只需要将下面这部分代码插入 fork 代码即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Map the same regions as the parent.</span></span><br><span class="line"><span class="keyword">for</span> (iter = p-&gt;vma; iter; iter = iter-&gt;next) &#123;</span><br><span class="line">  <span class="keyword">if</span> (mmap(np, iter-&gt;start, iter-&gt;end - iter-&gt;start, </span><br><span class="line">       iter-&gt;prot, iter-&gt;flags, iter-&gt;f, iter-&gt;offset) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    munmap(np, p-&gt;vma-&gt;start, MAXVMEMMAP);</span><br><span class="line">    freeproc(np);</span><br><span class="line">    release(&amp;np-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Reverse new process&#x27;s vma list.</span></span><br><span class="line"><span class="keyword">for</span> (prev = <span class="number">0</span>, iter = np-&gt;vma; iter; iter = next) &#123;</span><br><span class="line">  next = iter-&gt;next;</span><br><span class="line">  iter-&gt;next = prev;</span><br><span class="line">  prev = iter;</span><br><span class="line">&#125;</span><br><span class="line">np-&gt;vma = prev;</span><br></pre></td></tr></table></figure>
<p>至此，mmap lab 实现大功告成。</p>
<h2 id="完整代码">完整代码</h2>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/Makefile b/Makefile</span><br><span class="line"><span class="keyword">index</span> 8e74f52..8b658d3 <span class="number">100644</span></span><br><span class="line">--- a/Makefile</span><br><span class="line">+++ b/Makefile</span><br><span class="line"><span class="variable">@@</span> -<span class="number">188</span>,<span class="number">6</span> +<span class="number">188</span>,<span class="number">7</span> <span class="variable">@@</span> UPROGS=\</span><br><span class="line">    <span class="variable">$U</span>/_grind\</span><br><span class="line">    <span class="variable">$U</span>/_wc\</span><br><span class="line">    <span class="variable">$U</span>/_zombie\</span><br><span class="line">+   <span class="variable">$U</span>/_mmaptest\</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">diff --git a/kernel/defs.h b/kernel/defs.h</span><br><span class="line"><span class="keyword">index</span> 859fc41..9bb1c08 <span class="number">100644</span></span><br><span class="line">--- a/kernel/defs.h</span><br><span class="line">+++ b/kernel/defs.h</span><br><span class="line"><span class="variable">@@</span> -<span class="number">17</span>,<span class="number">6</span> +<span class="number">17</span>,<span class="number">9</span> <span class="variable">@@</span> struct mbuf;</span><br><span class="line"> struct sock;</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"> </span><br><span class="line">+<span class="comment">#define max(a, b) ((a) &gt; (b) ? (a) : (b))</span></span><br><span class="line">+<span class="comment">#define min(a, b) ((a) &lt; (b) ? (a) : (b))</span></span><br><span class="line">+</span><br><span class="line"> <span class="regexp">//</span> bio.c</span><br><span class="line"> void            binit(void);</span><br><span class="line"> struct buf*     bread(uint, uint);</span><br><span class="line"><span class="variable">@@</span> -<span class="number">41</span>,<span class="number">6</span> +<span class="number">44</span>,<span class="number">7</span> <span class="variable">@@</span> void            fileinit(void);</span><br><span class="line"> <span class="keyword">int</span>             fileread(struct file*, uint64, <span class="keyword">int</span> n);</span><br><span class="line"> <span class="keyword">int</span>             filestat(struct file*, uint64 addr);</span><br><span class="line"> <span class="keyword">int</span>             filewrite(struct file*, uint64, <span class="keyword">int</span> n);</span><br><span class="line">+<span class="keyword">int</span>             writeback(struct file*, off_t, uint64, <span class="keyword">int</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="regexp">//</span> fs.c</span><br><span class="line"> void            fsinit(<span class="keyword">int</span>);</span><br><span class="line"><span class="variable">@@</span> -<span class="number">103</span>,<span class="number">6</span> +<span class="number">107</span>,<span class="number">8</span> <span class="variable">@@</span> void            setkilled(struct proc*);</span><br><span class="line"> struct cpu*     mycpu(void);</span><br><span class="line"> struct cpu*     getmycpu(void);</span><br><span class="line"> struct proc*    myproc();</span><br><span class="line">+struct vma *    allocvma(void);</span><br><span class="line">+void            freevma(struct vma *);</span><br><span class="line"> void            procinit(void);</span><br><span class="line"> void            scheduler(void) __attribute__((noreturn));</span><br><span class="line"> void            sched(void);</span><br><span class="line"><span class="variable">@@</span> -<span class="number">187</span>,<span class="number">6</span> +<span class="number">193</span>,<span class="number">10</span> <span class="variable">@@</span> uint64          walkaddr(pagetable_t, uint64);</span><br><span class="line"> <span class="keyword">int</span>             copyout(pagetable_t, uint64, char *, uint64);</span><br><span class="line"> <span class="keyword">int</span>             copyin(pagetable_t, char *, uint64, uint64);</span><br><span class="line"> <span class="keyword">int</span>             copyinstr(pagetable_t, char *, uint64, uint64);</span><br><span class="line">+<span class="keyword">int</span>             do_mmap_page(struct vma*, uint64, pte_t*);</span><br><span class="line">+uint64          mmap(struct proc*, uint64, size_t, <span class="keyword">int</span>, <span class="keyword">int</span>, </span><br><span class="line">+                     struct file*, off_t offset);</span><br><span class="line">+uint64          munmap(struct proc*, uint64, uint64);</span><br><span class="line"> </span><br><span class="line"> <span class="regexp">//</span> plic.c</span><br><span class="line"> void            plicinit(void);</span><br><span class="line">diff --git a/kernel/fcntl.h b/kernel/fcntl.h</span><br><span class="line"><span class="keyword">index</span> 09f330a..353d3a4 <span class="number">100644</span></span><br><span class="line">--- a/kernel/fcntl.h</span><br><span class="line">+++ b/kernel/fcntl.h</span><br><span class="line"><span class="variable">@@</span> -<span class="number">9</span>,<span class="number">6</span> +<span class="number">9</span>,<span class="number">7</span> <span class="variable">@@</span></span><br><span class="line"> <span class="comment">#define PROT_READ       0x1</span></span><br><span class="line"> <span class="comment">#define PROT_WRITE      0x2</span></span><br><span class="line"> <span class="comment">#define PROT_EXEC       0x4</span></span><br><span class="line">+<span class="comment">#define PROT_RWX_MASK       (PROT_READ | PROT_WRITE | PROT_EXEC)</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">#define MAP_SHARED      0x01</span></span><br><span class="line"> <span class="comment">#define MAP_PRIVATE     0x02</span></span><br><span class="line">diff --git a/kernel/file.c b/kernel/file.c</span><br><span class="line"><span class="keyword">index</span> 25fa226..240ed29 <span class="number">100644</span></span><br><span class="line">--- a/kernel/file.c</span><br><span class="line">+++ b/kernel/file.c</span><br><span class="line"><span class="variable">@@</span> -<span class="number">180</span>,<span class="number">3</span> +<span class="number">180</span>,<span class="number">45</span> <span class="variable">@@</span> filewrite(struct file *f, uint64 addr, <span class="keyword">int</span> n)</span><br><span class="line">   <span class="keyword">return</span> ret;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">+<span class="regexp">//</span> Write back pages to file f.</span><br><span class="line">+<span class="regexp">//</span> addr is a kernel address.</span><br><span class="line">+<span class="keyword">int</span></span><br><span class="line">+writeback(struct file *f, off_t off, uint64 addr, <span class="keyword">int</span> nr_page) &#123;</span><br><span class="line">+  <span class="keyword">int</span> r, ret = <span class="number">0</span>;</span><br><span class="line">+  <span class="keyword">int</span> n;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span>(f-&gt;writable == <span class="number">0</span> || f-&gt;type != FD_INODE)</span><br><span class="line">+    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">+</span><br><span class="line">+  <span class="regexp">//</span> <span class="keyword">write</span> a few blocks at a <span class="keyword">time</span> to avoid exceeding</span><br><span class="line">+  <span class="regexp">//</span> the maximum <span class="keyword">log</span> transaction size, including</span><br><span class="line">+  <span class="regexp">//</span> i-node, indirect block, allocation blocks,</span><br><span class="line">+  <span class="regexp">//</span> <span class="keyword">and</span> <span class="number">2</span> blocks of slop <span class="keyword">for</span> non-aligned writes.</span><br><span class="line">+  <span class="regexp">//</span> this really belongs lower down, since writei()</span><br><span class="line">+  <span class="regexp">//</span> might be writing a device like the console.</span><br><span class="line">+  <span class="keyword">int</span> max = ((MAXOPBLOCKS-<span class="number">1</span>-<span class="number">1</span>-<span class="number">2</span>) / <span class="number">2</span>) * BSIZE;</span><br><span class="line">+  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">+</span><br><span class="line">+  n = nr_page * PGSIZE;</span><br><span class="line">+  <span class="keyword">while</span> (i &lt; n) &#123;</span><br><span class="line">+    <span class="keyword">int</span> n1 = n - i;</span><br><span class="line">+    <span class="keyword">if</span> (n1 &gt; max)</span><br><span class="line">+      n1 = max;</span><br><span class="line">+</span><br><span class="line">+    begin_op();</span><br><span class="line">+    ilock(f-&gt;ip);</span><br><span class="line">+    <span class="keyword">if</span> ((r = writei(f-&gt;ip, <span class="number">1</span>, addr + i, off, n1)) &gt; <span class="number">0</span>)</span><br><span class="line">+      off += r;</span><br><span class="line">+    iunlock(f-&gt;ip);</span><br><span class="line">+    end_op();</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">if</span>(r != n1)&#123;</span><br><span class="line">+      <span class="regexp">//</span> error from writei</span><br><span class="line">+      <span class="keyword">break</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+    i += r;</span><br><span class="line">+  &#125;</span><br><span class="line">+  ret = (i == n ? n : -<span class="number">1</span>);</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> ret;</span><br><span class="line">+&#125;</span><br><span class="line">\ No newline at end of file</span><br><span class="line">diff --git a/kernel/memlayout.h b/kernel/memlayout.h</span><br><span class="line"><span class="keyword">index</span> cac3cb1..8cc7d1c <span class="number">100644</span></span><br><span class="line">--- a/kernel/memlayout.h</span><br><span class="line">+++ b/kernel/memlayout.h</span><br><span class="line"><span class="variable">@@</span> -<span class="number">62</span>,<span class="number">3</span> +<span class="number">62</span>,<span class="number">5</span> <span class="variable">@@</span></span><br><span class="line"> //   TRAPFRAME (p-&gt;trapframe, used by the trampoline)</span><br><span class="line"> //   TRAMPOLINE (the same page as in the kernel)</span><br><span class="line"> <span class="comment">#define TRAPFRAME (TRAMPOLINE - PGSIZE)</span></span><br><span class="line">+</span><br><span class="line">+<span class="comment">#define MAXVMEMMAP (TRAPFRAME - PGSIZE)</span></span><br><span class="line">\ No newline at end of file</span><br><span class="line">diff --git a/kernel/param.h b/kernel/param.h</span><br><span class="line"><span class="keyword">index</span> 6624bff..3b99e82 <span class="number">100644</span></span><br><span class="line">--- a/kernel/param.h</span><br><span class="line">+++ b/kernel/param.h</span><br><span class="line"><span class="variable">@@</span> -<span class="number">1</span>,<span class="number">5</span> +<span class="number">1</span>,<span class="number">6</span> <span class="variable">@@</span></span><br><span class="line"> <span class="comment">#define NPROC        64  // maximum number of processes</span></span><br><span class="line"> <span class="comment">#define NCPU          8  // maximum number of CPUs</span></span><br><span class="line">+<span class="comment">#define NVMA         16  // maximum number of virtual memory areas</span></span><br><span class="line"> <span class="comment">#define NOFILE       16  // open files per process</span></span><br><span class="line"> <span class="comment">#define NFILE       100  // open files per system</span></span><br><span class="line"> <span class="comment">#define NINODE       50  // maximum number of active i-nodes</span></span><br><span class="line">diff --git a/kernel/proc.c b/kernel/proc.c</span><br><span class="line"><span class="keyword">index</span> 58a8a0b..d4bd931 <span class="number">100644</span></span><br><span class="line">--- a/kernel/proc.c</span><br><span class="line">+++ b/kernel/proc.c</span><br><span class="line"><span class="variable">@@</span> -<span class="number">12</span>,<span class="number">6</span> +<span class="number">12</span>,<span class="number">12</span> <span class="variable">@@</span> struct proc proc[NPROC];</span><br><span class="line"> </span><br><span class="line"> struct proc *initproc;</span><br><span class="line"> </span><br><span class="line">+struct &#123;</span><br><span class="line">+  struct vma _vma[NVMA];</span><br><span class="line">+  struct vma *free_vma_list;</span><br><span class="line">+  struct spinlock lock;</span><br><span class="line">+&#125; vma;</span><br><span class="line">+</span><br><span class="line"> <span class="keyword">int</span> nextpid = <span class="number">1</span>;</span><br><span class="line"> struct spinlock pid_lock;</span><br><span class="line"> </span><br><span class="line"><span class="variable">@@</span> -<span class="number">48</span>,<span class="number">6</span> +<span class="number">54</span>,<span class="number">7</span> <span class="variable">@@</span> void</span><br><span class="line"> procinit(void)</span><br><span class="line"> &#123;</span><br><span class="line">   struct proc *p;</span><br><span class="line">+  <span class="keyword">int</span> i;</span><br><span class="line"> </span><br><span class="line">   initlock(&amp;pid_lock, <span class="string">&quot;nextpid&quot;</span>);</span><br><span class="line">   initlock(&amp;wait_lock, <span class="string">&quot;wait_lock&quot;</span>);</span><br><span class="line"><span class="variable">@@</span> -<span class="number">56</span>,<span class="number">6</span> +<span class="number">63</span>,<span class="number">12</span> <span class="variable">@@</span> procinit(void)</span><br><span class="line">       p-&gt;<span class="keyword">state</span> = UNUSED;</span><br><span class="line">       p-&gt;kstack = KSTACK((<span class="keyword">int</span>) (p - proc));</span><br><span class="line">   &#125;</span><br><span class="line">+  </span><br><span class="line">+  initlock(&amp;vma.lock, <span class="string">&quot;vma&quot;</span>);</span><br><span class="line">+  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NVMA; ++i) &#123;</span><br><span class="line">+    vma._vma[i].next = vma.free_vma_list;</span><br><span class="line">+    vma.free_vma_list = &amp;vma._vma[i];</span><br><span class="line">+  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> // Must be called with interrupts disabled,</span><br><span class="line"><span class="variable">@@</span> -<span class="number">102</span>,<span class="number">6</span> +<span class="number">115</span>,<span class="number">27</span> <span class="variable">@@</span> allocpid()</span><br><span class="line">   <span class="keyword">return</span> pid;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">+struct vma *</span><br><span class="line">+allocvma(void) &#123;</span><br><span class="line">+  struct vma *v;</span><br><span class="line">+  </span><br><span class="line">+  acquire(&amp;vma.lock);</span><br><span class="line">+  v = vma.free_vma_list;</span><br><span class="line">+  <span class="keyword">if</span> (v)</span><br><span class="line">+    vma.free_vma_list = v-&gt;<span class="keyword">next</span>;</span><br><span class="line">+  release(&amp;vma.lock);</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> v;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+void</span><br><span class="line">+freevma(struct vma *v) &#123;</span><br><span class="line">+  acquire(&amp;vma.lock);</span><br><span class="line">+  v-&gt;<span class="keyword">next</span> = vma.free_vma_list;</span><br><span class="line">+  vma.free_vma_list = v;</span><br><span class="line">+  release(&amp;vma.lock);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="regexp">//</span> Look in the process table <span class="keyword">for</span> an UNUSED proc.</span><br><span class="line"> // If found, initialize <span class="keyword">state</span> required to run in the kernel,</span><br><span class="line"> <span class="regexp">//</span> <span class="keyword">and</span> <span class="keyword">return</span> with p-&gt;lock held.</span><br><span class="line"><span class="variable">@@</span> -<span class="number">161</span>,<span class="number">6</span> +<span class="number">195</span>,<span class="number">7</span> <span class="variable">@@</span> freeproc(struct proc *p)</span><br><span class="line">   <span class="keyword">if</span>(p-&gt;pagetable)</span><br><span class="line">     proc_freepagetable(p-&gt;pagetable, p-&gt;sz);</span><br><span class="line">   p-&gt;pagetable = <span class="number">0</span>;</span><br><span class="line">+  p-&gt;vma = <span class="number">0</span>;</span><br><span class="line">   p-&gt;sz = <span class="number">0</span>;</span><br><span class="line">   p-&gt;pid = <span class="number">0</span>;</span><br><span class="line">   p-&gt;parent = <span class="number">0</span>;</span><br><span class="line"><span class="variable">@@</span> -<span class="number">281</span>,<span class="number">6</span> +<span class="number">316</span>,<span class="number">7</span> <span class="variable">@@</span> <span class="keyword">fork</span>(void)</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="keyword">int</span> i, pid;</span><br><span class="line">   struct proc *np;</span><br><span class="line">+  struct vma *iter, *prev, *<span class="keyword">next</span>;</span><br><span class="line">   struct proc *p = myproc();</span><br><span class="line"> </span><br><span class="line">   <span class="regexp">//</span> Allocate process.</span><br><span class="line"><span class="variable">@@</span> -<span class="number">296</span>,<span class="number">6</span> +<span class="number">332</span>,<span class="number">24</span> <span class="variable">@@</span> <span class="keyword">fork</span>(void)</span><br><span class="line">   &#125;</span><br><span class="line">   np-&gt;sz = p-&gt;sz;</span><br><span class="line"> </span><br><span class="line">+  <span class="regexp">//</span> Map the same regions as the parent.</span><br><span class="line">+  <span class="keyword">for</span> (iter = p-&gt;vma; iter; iter = iter-&gt;<span class="keyword">next</span>) &#123;</span><br><span class="line">+    <span class="keyword">if</span> (mmap(np, iter-&gt;start, iter-&gt;end - iter-&gt;start, </span><br><span class="line">+         iter-&gt;prot, iter-&gt;flags, iter-&gt;f, iter-&gt;offset) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">+      munmap(np, p-&gt;vma-&gt;start, MAXVMEMMAP);</span><br><span class="line">+      freeproc(np);</span><br><span class="line">+      release(&amp;np-&gt;lock);</span><br><span class="line">+      <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="regexp">//</span> Reverse new process<span class="string">&#x27;s vma list.</span></span><br><span class="line"><span class="string">+  for (prev = 0, iter = np-&gt;vma; iter; iter = next) &#123;</span></span><br><span class="line"><span class="string">+    next = iter-&gt;next;</span></span><br><span class="line"><span class="string">+    iter-&gt;next = prev;</span></span><br><span class="line"><span class="string">+    prev = iter;</span></span><br><span class="line"><span class="string">+  &#125;</span></span><br><span class="line"><span class="string">+  np-&gt;vma = prev;</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">   // copy saved user registers.</span></span><br><span class="line"><span class="string">   *(np-&gt;trapframe) = *(p-&gt;trapframe);</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">@@ -351,6 +405,10 @@ exit(int status)</span></span><br><span class="line"><span class="string">   if(p == initproc)</span></span><br><span class="line"><span class="string">     panic(&quot;init exiting&quot;);</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">+  // unmap the process&#x27;</span>s mapped regions</span><br><span class="line">+  <span class="keyword">if</span> (p-&gt;vma)</span><br><span class="line">+    munmap(p, p-&gt;vma-&gt;start, MAXVMEMMAP);</span><br><span class="line">+</span><br><span class="line">   <span class="regexp">//</span> Close all <span class="keyword">open</span> files.</span><br><span class="line">   <span class="keyword">for</span>(<span class="keyword">int</span> fd = <span class="number">0</span>; fd &lt; NOFILE; fd++)&#123;</span><br><span class="line">     <span class="keyword">if</span>(p-&gt;ofile[fd])&#123;</span><br><span class="line">diff --git a/kernel/proc.h b/kernel/proc.h</span><br><span class="line"><span class="keyword">index</span> d021857..133dfef <span class="number">100644</span></span><br><span class="line">--- a/kernel/proc.h</span><br><span class="line">+++ b/kernel/proc.h</span><br><span class="line"><span class="variable">@@</span> -<span class="number">79</span>,<span class="number">6</span> +<span class="number">79</span>,<span class="number">16</span> <span class="variable">@@</span> struct trapframe &#123;</span><br><span class="line">   <span class="regexp">/* 280 */</span> uint64 t6;</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line">+struct vma &#123;</span><br><span class="line">+  uint64 start;</span><br><span class="line">+  uint64 end;</span><br><span class="line">+  <span class="keyword">int</span> prot;</span><br><span class="line">+  <span class="keyword">int</span> flags;</span><br><span class="line">+  struct file *f;</span><br><span class="line">+  uint64 offset;</span><br><span class="line">+  struct vma *<span class="keyword">next</span>;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line"> enum procstate &#123; UNUSED, USED, SLEEPING, RUNNABLE, RUNNING, ZOMBIE &#125;;</span><br><span class="line"> </span><br><span class="line"> <span class="regexp">//</span> Per-process <span class="keyword">state</span></span><br><span class="line"><span class="variable">@@</span> -<span class="number">96</span>,<span class="number">6</span> +<span class="number">106</span>,<span class="number">7</span> <span class="variable">@@</span> struct proc &#123;</span><br><span class="line">   struct proc *parent;         <span class="regexp">//</span> Parent process</span><br><span class="line"> </span><br><span class="line">   // these are private to the process, so p-&gt;lock need <span class="keyword">not</span> be held.</span><br><span class="line">+  struct vma *vma;             <span class="regexp">//</span> Virtual memory areas (<span class="keyword">for</span> mmap)</span><br><span class="line">   uint64 kstack;               <span class="regexp">//</span> Virtual address of kernel stack</span><br><span class="line">   uint64 sz;                   <span class="regexp">//</span> Size of process memory (bytes)</span><br><span class="line">   pagetable_t pagetable;       <span class="regexp">//</span> User page table</span><br><span class="line">diff --git a/kernel/riscv.h b/kernel/riscv.h</span><br><span class="line"><span class="keyword">index</span> 20a01db..c7da5a0 <span class="number">100644</span></span><br><span class="line">--- a/kernel/riscv.h</span><br><span class="line">+++ b/kernel/riscv.h</span><br><span class="line"><span class="variable">@@</span> -<span class="number">343</span>,<span class="number">6</span> +<span class="number">343</span>,<span class="number">7</span> <span class="variable">@@</span> typedef uint64 *pagetable_t; <span class="regexp">//</span> <span class="number">512</span> PTEs</span><br><span class="line"> <span class="comment">#define PTE_W (1L &lt;&lt; 2)</span></span><br><span class="line"> <span class="comment">#define PTE_X (1L &lt;&lt; 3)</span></span><br><span class="line"> <span class="comment">#define PTE_U (1L &lt;&lt; 4) // user can access</span></span><br><span class="line">+<span class="comment">#define PTE_D (1L &lt;&lt; 7) // dirty</span></span><br><span class="line"> </span><br><span class="line"> // <span class="keyword">shift</span> a physical address to the right place <span class="keyword">for</span> a PTE.</span><br><span class="line"> <span class="comment">#define PA2PTE(pa) ((((uint64)pa) &gt;&gt; 12) &lt;&lt; 10)</span></span><br><span class="line">diff --git a/kernel/syscall.c b/kernel/syscall.c</span><br><span class="line"><span class="keyword">index</span> ed65409..4fb9baa <span class="number">100644</span></span><br><span class="line">--- a/kernel/syscall.c</span><br><span class="line">+++ b/kernel/syscall.c</span><br><span class="line"><span class="variable">@@</span> -<span class="number">101</span>,<span class="number">6</span> +<span class="number">101</span>,<span class="number">8</span> <span class="variable">@@</span> extern uint64 sys_unlink(void);</span><br><span class="line"> extern uint64 sys_link(void);</span><br><span class="line"> extern uint64 sys_mkdir(void);</span><br><span class="line"> extern uint64 sys_close(void);</span><br><span class="line">+extern uint64 sys_mmap(void);</span><br><span class="line">+extern uint64 sys_munmap(void);</span><br><span class="line"> </span><br><span class="line"> <span class="regexp">//</span> An array mapping <span class="keyword">syscall</span> numbers from syscall.h</span><br><span class="line"> // to the function that handles the <span class="keyword">system</span> call.</span><br><span class="line"><span class="variable">@@</span> -<span class="number">126</span>,<span class="number">6</span> +<span class="number">128</span>,<span class="number">8</span> <span class="variable">@@</span> static uint64 (*syscalls[])(void) = &#123;</span><br><span class="line"> [SYS_link]    sys_link,</span><br><span class="line"> [SYS_mkdir]   sys_mkdir,</span><br><span class="line"> [SYS_close]   sys_close,</span><br><span class="line">+[SYS_mmap]    sys_mmap,</span><br><span class="line">+[SYS_munmap]  sys_munmap,</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> void</span><br><span class="line">diff --git a/kernel/syscall.h b/kernel/syscall.h</span><br><span class="line"><span class="keyword">index</span> bc5f356..e7b18d6 <span class="number">100644</span></span><br><span class="line">--- a/kernel/syscall.h</span><br><span class="line">+++ b/kernel/syscall.h</span><br><span class="line"><span class="variable">@@</span> -<span class="number">20</span>,<span class="number">3</span> +<span class="number">20</span>,<span class="number">5</span> <span class="variable">@@</span></span><br><span class="line"> <span class="comment">#define SYS_link   19</span></span><br><span class="line"> <span class="comment">#define SYS_mkdir  20</span></span><br><span class="line"> <span class="comment">#define SYS_close  21</span></span><br><span class="line">+<span class="comment">#define SYS_mmap   22</span></span><br><span class="line">+<span class="comment">#define SYS_munmap 23</span></span><br><span class="line">diff --git a/kernel/sysfile.c b/kernel/sysfile.c</span><br><span class="line"><span class="keyword">index</span> 16b668c..cb5c751 <span class="number">100644</span></span><br><span class="line">--- a/kernel/sysfile.c</span><br><span class="line">+++ b/kernel/sysfile.c</span><br><span class="line"><span class="variable">@@</span> -<span class="number">15</span>,<span class="number">6</span> +<span class="number">15</span>,<span class="number">7</span> <span class="variable">@@</span></span><br><span class="line"> <span class="comment">#include &quot;sleeplock.h&quot;</span></span><br><span class="line"> <span class="comment">#include &quot;file.h&quot;</span></span><br><span class="line"> <span class="comment">#include &quot;fcntl.h&quot;</span></span><br><span class="line">+<span class="comment">#include &quot;memlayout.h&quot;</span></span><br><span class="line"> </span><br><span class="line"> // Fetch the nth word-sized <span class="keyword">system</span> call argument as a file descriptor</span><br><span class="line"> // <span class="keyword">and</span> <span class="keyword">return</span> both the descriptor <span class="keyword">and</span> the corresponding struct file.</span><br><span class="line"><span class="variable">@@</span> -<span class="number">503</span>,<span class="number">3</span> +<span class="number">504</span>,<span class="number">54</span> <span class="variable">@@</span> sys_pipe(void)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line">+</span><br><span class="line">+uint64</span><br><span class="line">+sys_mmap(void) &#123;</span><br><span class="line">+  <span class="regexp">//</span> void *mmap(void *addr, size_t len, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags,</span><br><span class="line">+  <span class="regexp">//</span>            <span class="keyword">int</span> fd, off_t offset);</span><br><span class="line">+  <span class="regexp">//</span> we assume both addr <span class="keyword">and</span> offset are <span class="number">0</span>, so we won<span class="string">&#x27;t use them </span></span><br><span class="line"><span class="string">+  size_t len;</span></span><br><span class="line"><span class="string">+  int prot, flags;</span></span><br><span class="line"><span class="string">+  struct file *f;</span></span><br><span class="line"><span class="string">+  struct proc *p = myproc();</span></span><br><span class="line"><span class="string">+  </span></span><br><span class="line"><span class="string">+  argaddr(1, &amp;len);</span></span><br><span class="line"><span class="string">+  argint(2, &amp;prot);</span></span><br><span class="line"><span class="string">+  argint(3, &amp;flags);</span></span><br><span class="line"><span class="string">+  if (argfd(4, 0, &amp;f) &lt; 0) &#123;</span></span><br><span class="line"><span class="string">+    return -1;</span></span><br><span class="line"><span class="string">+  &#125;</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+  if (flags == 0 || ((flags &amp; MAP_PRIVATE) &amp;&amp; (flags &amp; MAP_SHARED))) &#123;</span></span><br><span class="line"><span class="string">+    return -1;</span></span><br><span class="line"><span class="string">+  &#125;</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+  if (f-&gt;type != FD_INODE || f-&gt;ip-&gt;type != T_FILE </span></span><br><span class="line"><span class="string">+      || len == 0) &#123; // len &gt; f-&gt;ip-&gt;size is allowed</span></span><br><span class="line"><span class="string">+    return -1;</span></span><br><span class="line"><span class="string">+  &#125;</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+  if (((prot &amp; PROT_READ) &amp;&amp; !f-&gt;readable) || </span></span><br><span class="line"><span class="string">+      ((prot &amp; PROT_WRITE) &amp;&amp; !f-&gt;writable &amp;&amp; !(flags &amp; MAP_PRIVATE))) &#123;</span></span><br><span class="line"><span class="string">+    return -1;</span></span><br><span class="line"><span class="string">+  &#125;</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+  return mmap(p, 0, len, prot, flags, f, 0);</span></span><br><span class="line"><span class="string">+&#125;</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+uint64</span></span><br><span class="line"><span class="string">+sys_munmap(void) &#123;</span></span><br><span class="line"><span class="string">+  uint64 addr, start, end;</span></span><br><span class="line"><span class="string">+  size_t len;</span></span><br><span class="line"><span class="string">+  struct proc *p = myproc();</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+  argaddr(0, &amp;addr); // addr is page-aligned</span></span><br><span class="line"><span class="string">+  argaddr(1, &amp;len);</span></span><br><span class="line"><span class="string">+  if (addr % PGSIZE) &#123;</span></span><br><span class="line"><span class="string">+    return -1;</span></span><br><span class="line"><span class="string">+  &#125;</span></span><br><span class="line"><span class="string">+  start = addr;</span></span><br><span class="line"><span class="string">+  end = PGROUNDUP(addr + len);</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+  return munmap(p, start, end);  </span></span><br><span class="line"><span class="string">+&#125;</span></span><br><span class="line"><span class="string">\ No newline at end of file</span></span><br><span class="line"><span class="string">diff --git a/kernel/trap.c b/kernel/trap.c</span></span><br><span class="line"><span class="string">index 512c850..f555643 100644</span></span><br><span class="line"><span class="string">--- a/kernel/trap.c</span></span><br><span class="line"><span class="string">+++ b/kernel/trap.c</span></span><br><span class="line"><span class="string">@@ -36,7 +36,11 @@ trapinithart(void)</span></span><br><span class="line"><span class="string"> void</span></span><br><span class="line"><span class="string"> usertrap(void)</span></span><br><span class="line"><span class="string"> &#123;</span></span><br><span class="line"><span class="string">-  int which_dev = 0;</span></span><br><span class="line"><span class="string">+  uint64 scause;</span></span><br><span class="line"><span class="string">+  uint64 va, pa;</span></span><br><span class="line"><span class="string">+  pte_t *pte;</span></span><br><span class="line"><span class="string">+  struct vma *vma = 0, *iter;</span></span><br><span class="line"><span class="string">+  int which_dev = 0, rc;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">   if((r_sstatus() &amp; SSTATUS_SPP) != 0)</span></span><br><span class="line"><span class="string">     panic(&quot;usertrap: not from user mode&quot;);</span></span><br><span class="line"><span class="string">@@ -50,7 +54,7 @@ usertrap(void)</span></span><br><span class="line"><span class="string">   // save user program counter.</span></span><br><span class="line"><span class="string">   p-&gt;trapframe-&gt;epc = r_sepc();</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">-  if(r_scause() == 8)&#123;</span></span><br><span class="line"><span class="string">+  if((scause = r_scause()) == 8)&#123;</span></span><br><span class="line"><span class="string">     // system call</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">     if(killed(p))</span></span><br><span class="line"><span class="string">@@ -67,7 +71,39 @@ usertrap(void)</span></span><br><span class="line"><span class="string">     syscall();</span></span><br><span class="line"><span class="string">   &#125; else if((which_dev = devintr()) != 0)&#123;</span></span><br><span class="line"><span class="string">     // ok</span></span><br><span class="line"><span class="string">+  &#125; else</span></span><br><span class="line"><span class="string">+  if (scause == 12 || scause == 13 || scause == 15) &#123;</span></span><br><span class="line"><span class="string">+    // instruction/load/store/AMO page fault</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+    va = r_stval();</span></span><br><span class="line"><span class="string">+    if (va &gt;= MAXVA)</span></span><br><span class="line"><span class="string">+      goto KILL;</span></span><br><span class="line"><span class="string">+    </span></span><br><span class="line"><span class="string">+    va = PGROUNDDOWN(va);</span></span><br><span class="line"><span class="string">+    pte = walk(p-&gt;pagetable, va, 0);</span></span><br><span class="line"><span class="string">+    if (!pte)    // no page table entry for va</span></span><br><span class="line"><span class="string">+      goto KILL;</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+    pa = PTE2PA(*pte);</span></span><br><span class="line"><span class="string">+    if (pa != 0) // page access permission denied</span></span><br><span class="line"><span class="string">+      goto KILL;</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+    for (iter = p-&gt;vma; iter; iter = iter-&gt;next) &#123;</span></span><br><span class="line"><span class="string">+      if (va &gt;= iter-&gt;start &amp;&amp; va &lt; iter-&gt;end) &#123;</span></span><br><span class="line"><span class="string">+        vma = iter;</span></span><br><span class="line"><span class="string">+        break;</span></span><br><span class="line"><span class="string">+      &#125;</span></span><br><span class="line"><span class="string">+    &#125;</span></span><br><span class="line"><span class="string">+    if (!vma) // va is out of mmap-ed range</span></span><br><span class="line"><span class="string">+      goto KILL;</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+    rc = do_mmap_page(vma, va, pte);</span></span><br><span class="line"><span class="string">+    if (rc != 0) &#123;</span></span><br><span class="line"><span class="string">+      printf(&quot;do_mmap_page failed: %d\n&quot;, rc);</span></span><br><span class="line"><span class="string">+      goto KILL;</span></span><br><span class="line"><span class="string">+    &#125;</span></span><br><span class="line"><span class="string">   &#125; else &#123;</span></span><br><span class="line"><span class="string">+  KILL:</span></span><br><span class="line"><span class="string">     printf(&quot;usertrap(): unexpected scause %p pid=%d\n&quot;, r_scause(), p-&gt;pid);</span></span><br><span class="line"><span class="string">     printf(&quot;            sepc=%p stval=%p\n&quot;, r_sepc(), r_stval());</span></span><br><span class="line"><span class="string">     setkilled(p);</span></span><br><span class="line"><span class="string">diff --git a/kernel/vm.c b/kernel/vm.c</span></span><br><span class="line"><span class="string">index 5c31e87..5682b4d 100644</span></span><br><span class="line"><span class="string">--- a/kernel/vm.c</span></span><br><span class="line"><span class="string">+++ b/kernel/vm.c</span></span><br><span class="line"><span class="string">@@ -5,6 +5,11 @@</span></span><br><span class="line"><span class="string"> #include &quot;riscv.h&quot;</span></span><br><span class="line"><span class="string"> #include &quot;defs.h&quot;</span></span><br><span class="line"><span class="string"> #include &quot;fs.h&quot;</span></span><br><span class="line"><span class="string">+#include &quot;fcntl.h&quot;</span></span><br><span class="line"><span class="string">+#include &quot;spinlock.h&quot;</span></span><br><span class="line"><span class="string">+#include &quot;sleeplock.h&quot;</span></span><br><span class="line"><span class="string">+#include &quot;proc.h&quot;</span></span><br><span class="line"><span class="string">+#include &quot;file.h&quot;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"> /*</span></span><br><span class="line"><span class="string">  * the kernel&#x27;</span>s page table.</span><br><span class="line"><span class="variable">@@</span> -<span class="number">188</span>,<span class="number">11</span> +<span class="number">193</span>,<span class="number">14</span> <span class="variable">@@</span> uvmunmap(pagetable_t pagetable, uint64 va, uint64 npages, <span class="keyword">int</span> do_free)</span><br><span class="line">       panic(<span class="string">&quot;uvmunmap: walk&quot;</span>);</span><br><span class="line">     <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>)</span><br><span class="line">       panic(<span class="string">&quot;uvmunmap: not mapped&quot;</span>);</span><br><span class="line">+    <span class="regexp">//</span> It<span class="string">&#x27;s ok that PTE_FLAGS only has PTE_V, because the PTE</span></span><br><span class="line"><span class="string">+    // hasn&#x27;</span>t been allocated a physical page yet.</span><br><span class="line">     <span class="keyword">if</span>(PTE_FLAGS(*pte) == PTE_V)</span><br><span class="line">       panic(<span class="string">&quot;uvmunmap: not a leaf&quot;</span>);</span><br><span class="line">     <span class="keyword">if</span>(do_free)&#123;</span><br><span class="line">       uint64 pa = PTE2PA(*pte);</span><br><span class="line">-      kfree((void*)pa);</span><br><span class="line">+      <span class="keyword">if</span> (pa != <span class="number">0</span>)</span><br><span class="line">+        kfree((void*)pa);</span><br><span class="line">     &#125;</span><br><span class="line">     *pte = <span class="number">0</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="variable">@@</span> -<span class="number">449</span>,<span class="number">3</span> +<span class="number">457</span>,<span class="number">139</span> <span class="variable">@@</span> copyinstr(pagetable_t pagetable, char *dst, uint64 srcva, uint64 max)</span><br><span class="line">     <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">int</span></span><br><span class="line">+do_mmap_page(struct vma *vma, uint64 addr, pte_t *pte) &#123;</span><br><span class="line">+  char *mem;</span><br><span class="line">+  struct file *f;</span><br><span class="line">+  off_t offset;</span><br><span class="line">+  uint64 pte_flags;</span><br><span class="line">+  <span class="keyword">int</span> rc;</span><br><span class="line">+</span><br><span class="line">+  mem = kalloc();</span><br><span class="line">+  <span class="keyword">if</span> (mem == <span class="number">0</span>) &#123;</span><br><span class="line">+    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+  </span><br><span class="line">+  f = vma-&gt;f;</span><br><span class="line">+  offset = vma-&gt;offset + (addr - vma-&gt;start);</span><br><span class="line">+  ilock(f-&gt;ip);</span><br><span class="line">+  <span class="keyword">if</span> ((rc = readi(f-&gt;ip, <span class="number">0</span>, (uint64)mem, offset, PGSIZE)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">+    iunlock(f-&gt;ip);</span><br><span class="line">+    kfree(mem);</span><br><span class="line">+    <span class="keyword">return</span> -<span class="number">2</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+  iunlock(f-&gt;ip);</span><br><span class="line">+</span><br><span class="line">+  <span class="regexp">//</span> zero-fill the rest of the page</span><br><span class="line">+  <span class="keyword">if</span> (rc &lt; PGSIZE) &#123;</span><br><span class="line">+    memset(mem + rc, <span class="number">0</span>, PGSIZE - rc);</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  pte_flags = PTE_FLAGS(*pte);</span><br><span class="line">+  pte_flags |= (vma-&gt;prot &amp; PROT_RWX_MASK) &lt;&lt; <span class="number">1</span>;</span><br><span class="line">+  *pte = PA2PTE((uint64)mem) | pte_flags;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+uint64</span><br><span class="line">+mmap(struct proc *p, uint64 addr, size_t len, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, </span><br><span class="line">+     struct file *f, off_t offset) &#123;</span><br><span class="line">+  struct vma *vma;</span><br><span class="line">+  size_t len_aligned;</span><br><span class="line">+</span><br><span class="line">+  vma = allocvma();</span><br><span class="line">+  <span class="keyword">if</span> (vma == <span class="number">0</span>) &#123;</span><br><span class="line">+    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  len_aligned = PGROUNDUP(len);</span><br><span class="line">+  <span class="keyword">if</span> (addr == <span class="number">0</span>) &#123;</span><br><span class="line">+    <span class="keyword">if</span> (p-&gt;vma == <span class="number">0</span>) &#123;</span><br><span class="line">+      vma-&gt;end = MAXVMEMMAP;</span><br><span class="line">+    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">+      vma-&gt;end = p-&gt;vma-&gt;start;</span><br><span class="line">+    &#125;</span><br><span class="line">+    vma-&gt;start = vma-&gt;end - len_aligned;</span><br><span class="line">+  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">+    vma-&gt;start = addr;  </span><br><span class="line">+    vma-&gt;end = addr + len_aligned;</span><br><span class="line">+  &#125;</span><br><span class="line">+  vma-&gt;flags = flags;</span><br><span class="line">+  vma-&gt;prot = prot;</span><br><span class="line">+  vma-&gt;f = f;</span><br><span class="line">+  vma-&gt;offset = offset;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">for</span> (addr = vma-&gt;start; addr &lt; vma-&gt;end; addr += PGSIZE) &#123;</span><br><span class="line">+    <span class="keyword">if</span> (mappages(p-&gt;pagetable, addr, PGSIZE, <span class="number">0</span>, PTE_U) != <span class="number">0</span>) &#123;</span><br><span class="line">+      freevma(vma);</span><br><span class="line">+      <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  vma-&gt;<span class="keyword">next</span> = p-&gt;vma;</span><br><span class="line">+  p-&gt;vma = vma;</span><br><span class="line">+</span><br><span class="line">+  <span class="regexp">//</span> duplicate the file descriptor so that </span><br><span class="line">+  <span class="regexp">//</span> the structure doesn<span class="string">&#x27;t disappear when the file is closed</span></span><br><span class="line"><span class="string">+  filedup(f);</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+  return vma-&gt;start;</span></span><br><span class="line"><span class="string">+&#125;</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+uint64</span></span><br><span class="line"><span class="string">+munmap(struct proc *p, uint64 start, uint64 end) &#123;</span></span><br><span class="line"><span class="string">+  uint64 addr, l, r, flags;</span></span><br><span class="line"><span class="string">+  struct vma *iter, *iter2, *prev = 0;</span></span><br><span class="line"><span class="string">+  pte_t *pte;</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+  for (iter = p-&gt;vma; iter;) &#123;</span></span><br><span class="line"><span class="string">+    l = max(start, iter-&gt;start);</span></span><br><span class="line"><span class="string">+    r = min(end, iter-&gt;end);</span></span><br><span class="line"><span class="string">+    if (l &gt;= r) &#123;</span></span><br><span class="line"><span class="string">+      prev = iter;</span></span><br><span class="line"><span class="string">+      iter = iter-&gt;next;</span></span><br><span class="line"><span class="string">+      continue;</span></span><br><span class="line"><span class="string">+    &#125;</span></span><br><span class="line"><span class="string">+    if (iter-&gt;flags &amp; MAP_SHARED) &#123;</span></span><br><span class="line"><span class="string">+      begin_op();</span></span><br><span class="line"><span class="string">+      for (addr = l; addr &lt; r; addr += PGSIZE) &#123;</span></span><br><span class="line"><span class="string">+        pte = walk(p-&gt;pagetable, addr, 0);</span></span><br><span class="line"><span class="string">+        flags = PTE_FLAGS(*pte);</span></span><br><span class="line"><span class="string">+        if (flags &amp; PTE_D) &#123;</span></span><br><span class="line"><span class="string">+          if (writeback(iter-&gt;f, iter-&gt;offset + addr - iter-&gt;start, addr, 1) &lt; 0) &#123;</span></span><br><span class="line"><span class="string">+            end_op();</span></span><br><span class="line"><span class="string">+            return -1;</span></span><br><span class="line"><span class="string">+          &#125;</span></span><br><span class="line"><span class="string">+        &#125;</span></span><br><span class="line"><span class="string">+      &#125;</span></span><br><span class="line"><span class="string">+      end_op();</span></span><br><span class="line"><span class="string">+    &#125;</span></span><br><span class="line"><span class="string">+    uvmunmap(p-&gt;pagetable, l, (r - l) / PGSIZE, 1);</span></span><br><span class="line"><span class="string">+    if (l == iter-&gt;start &amp;&amp; r == iter-&gt;end) &#123;</span></span><br><span class="line"><span class="string">+      fileclose(iter-&gt;f);</span></span><br><span class="line"><span class="string">+      if (prev) &#123;</span></span><br><span class="line"><span class="string">+        prev-&gt;next = iter-&gt;next;</span></span><br><span class="line"><span class="string">+      &#125; else &#123;</span></span><br><span class="line"><span class="string">+        p-&gt;vma = iter-&gt;next;</span></span><br><span class="line"><span class="string">+      &#125;</span></span><br><span class="line"><span class="string">+      iter2 = iter;</span></span><br><span class="line"><span class="string">+      iter = iter-&gt;next;</span></span><br><span class="line"><span class="string">+      freevma(iter2);</span></span><br><span class="line"><span class="string">+    &#125; else &#123;</span></span><br><span class="line"><span class="string">+      if (l == iter-&gt;start) &#123;</span></span><br><span class="line"><span class="string">+        iter-&gt;offset += r - l;</span></span><br><span class="line"><span class="string">+        iter-&gt;start = r;</span></span><br><span class="line"><span class="string">+      &#125; else if (r == iter-&gt;end) &#123;</span></span><br><span class="line"><span class="string">+        iter-&gt;end = l;</span></span><br><span class="line"><span class="string">+      &#125; else &#123;</span></span><br><span class="line"><span class="string">+        panic(&quot;munmap: punch a hole in the middle of a region&quot;);</span></span><br><span class="line"><span class="string">+      &#125;</span></span><br><span class="line"><span class="string">+      prev = iter;</span></span><br><span class="line"><span class="string">+      iter = iter-&gt;next;</span></span><br><span class="line"><span class="string">+    &#125;</span></span><br><span class="line"><span class="string">+  &#125;</span></span><br><span class="line"><span class="string">+</span></span><br><span class="line"><span class="string">+  return 0;</span></span><br><span class="line"><span class="string">+&#125;</span></span><br><span class="line"><span class="string">\ No newline at end of file</span></span><br><span class="line"><span class="string">diff --git a/user/user.h b/user/user.h</span></span><br><span class="line"><span class="string">index 2d6ace6..2fbcdd9 100644</span></span><br><span class="line"><span class="string">--- a/user/user.h</span></span><br><span class="line"><span class="string">+++ b/user/user.h</span></span><br><span class="line"><span class="string">@@ -26,6 +26,8 @@ int getpid(void);</span></span><br><span class="line"><span class="string"> char* sbrk(int);</span></span><br><span class="line"><span class="string"> int sleep(int);</span></span><br><span class="line"><span class="string"> int uptime(void);</span></span><br><span class="line"><span class="string">+void *mmap(void*, size_t, int, int, int, off_t);</span></span><br><span class="line"><span class="string">+int munmap(void*, size_t);</span></span><br><span class="line"><span class="string"> #ifdef LAB_NET</span></span><br><span class="line"><span class="string"> int connect(uint32, uint16, uint16);</span></span><br><span class="line"><span class="string"> #endif</span></span><br><span class="line"><span class="string">diff --git a/user/usys.pl b/user/usys.pl</span></span><br><span class="line"><span class="string">index 01e426e..d23b9cc 100755</span></span><br><span class="line"><span class="string">--- a/user/usys.pl</span></span><br><span class="line"><span class="string">+++ b/user/usys.pl</span></span><br><span class="line"><span class="string">@@ -36,3 +36,5 @@ entry(&quot;getpid&quot;);</span></span><br><span class="line"><span class="string"> entry(&quot;sbrk&quot;);</span></span><br><span class="line"><span class="string"> entry(&quot;sleep&quot;);</span></span><br><span class="line"><span class="string"> entry(&quot;uptime&quot;);</span></span><br><span class="line"><span class="string">+entry(&quot;mmap&quot;);</span></span><br><span class="line"><span class="string">+entry(&quot;munmap&quot;);</span></span><br></pre></td></tr></table></figure>
<h2 id="Reference">Reference</h2>
<p><a target="_blank" rel="noopener" href="https://lrl52.top/1234/6-1810-lab10-mmap-mmap/">6.1810 Lab10 mmap: Mmap</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://taffy128.github.io/">lzx</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://taffy128.github.io/2025/11/28/6-S081-Lab10-Mmap/">https://taffy128.github.io/2025/11/28/6-S081-Lab10-Mmap/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://taffy128.github.io" target="_blank">lzx's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">C++学习笔记</a></div><div class="post-share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/11/28/6-S081-Lecture-Notes/" title="6.S081_Lecture Notes"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">6.S081_Lecture Notes</div></div><div class="info-2"><div class="info-item-1">6.S081_Lecture Notes 课程网址：https://pdos.csail.mit.edu/6.S081/2020/index.html Lecture 1 Introduction 操作系统应该提供的功能：1. 多进程支持 2. 进程间隔离 3. 受控制的进程间通信  xv6：一种在本课程中使用的类UNIX的教学操作系统，运行在RISC-V指令集处理器上，本课程中将使用QEMU模拟器代替 kernel(内核)：为运行的程序提供服务的一种特殊程序。每个运行着的程序叫做进程，每个进程的内存中存储指令、数据和堆栈。一个计算机可以拥有多个进程，但是只能有一个内核  每当进程需要调用内核时，它会触发一个system call（系统调用），system call进入内核执行相应的服务然后返回。   shell：一个普通的程序，其功能是让用户输入命令并执行它们，shell不是内核的一部分  1.1 Processes and...</div></div></div></a><a class="pagination-related" href="/2025/11/26/6-S081-Lab9-File-system/" title="6.S081_Lab9_File system"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">6.S081_Lab9_File system</div></div><div class="info-2"><div class="info-item-1">6.S081_Lab9_File system 写在前面 如果一行代码都还没有写，不知道完全要在哪里写，写什么东西，说明是对xv6的相关机制不懂，继续反复阅读xv6book 如果是写了一些代码，但是运行不起来，或者运行情况与预期不符，可以尝试询问AI或者用gdb逐行调试 如果已经花费了超额时间（例如easy题目仅做题时间超过1.5h），可以尝试阅读别人的源码，但是一定不要边看边写，要彻底看懂后自己完整的敲出来 Lab9地址 课程首页 Large files Xv6 目前的 inode 仅支持 12 个直接索引块和 1 个一级间接索引块，由于 BSIZE 是 1KB，每个 block number 是 4 字节，1KB 里可以存放 个 block number，因此一个文件最多只能 refer 到 个 block，即文件大小最大为 268 KB。 这个 task 需要你实现一个二级索引，一个二级索引可以索引 个 block，占用 1 个直接索引来实现一个二级索引，这样可以让 Xv6 支持的文件大小变为  KB。 实现难度不大，在 bmap...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/09/13/6-S081-Lab0-Environment-Setup/" title="6.S081_Lab0_Environment Setup"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-13</div><div class="info-item-2">6.S081_Lab0_Environment Setup</div></div><div class="info-2"><div class="info-item-1">6.S081_Lab0_Environment Setup 写在前面 本文旨在为 MIT 6.S081: Operating System Engineering (RISC-V 版本) 的学习者提供一份完整、详尽的开发与调试环境搭建步骤。一个配置完善的环境是高效完成课程实验、深入理解操作系统内核的关键。本教程将引导你完成从安装工具链到配置图形化调试环境的全过程。 第一部分：基础概念 在开始配置前，理解以下几个核心概念，有助于清晰地认识整个开发与调试工作流。 1.1. 宿主机 (Host) 与客户机 (Guest) 整个开发过程涉及两个相互独立的系统环境：  宿主操作系统 (Host OS)：这是你用于开发和编译的系统，通常是一个 Linux 发行版（如 Ubuntu）。所有的开发工具，包括编译器、模拟器和调试器，都安装并运行在宿主机上。 客户操作系统 (Guest OS)：这是你正在学习和开发的操作系统，即 xv6。它运行在由模拟器创建的独立虚拟环境中。  1.2. QEMU 的角色 QEMU 是一个开源的系统模拟器。在本课程中，它的作用是提供一个完整的、软件模拟的...</div></div></div></a><a class="pagination-related" href="/2025/09/13/6-S081-Lab1-Unix-Utilities/" title="6.S081_Lab1_Unix Utilities"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-13</div><div class="info-item-2">6.S081_Lab1_Unix Utilities</div></div><div class="info-2"><div class="info-item-1">6.S081_Lab1_Unix Utilities 写在前面 这是本课程第一次正式Lab，自行完成需要耗费一定的时间 如果一行代码都还没有写，不知道完全要在哪里写，写什么东西，说明是对xv6的相关机制不懂，继续反复阅读xv6book 如果是写了一些代码，但是运行不起来，或者运行情况与预期不符，可以尝试询问AI或者用gdb逐行调试 如果已经花费了超额时间（例如easy题目仅做题时间超过1.5h），可以尝试阅读别人的源码，但是一定不要边看边写，要彻底看懂后自己完整的敲出来 Lab1地址 课程首页 0.Makefile 每个任务完成之后需要在Makefile中添加对应的信息才能运行 在UPROGS项下添加以下内容： 12345$U/_sleep\$U/_pingpong\$U/_primes\$U/_find\$U/_xargs\ 1.Sleep 通过sleep系统调用来实现休眠一定时间，注意如果没有传入参数，程序需要打印错误信息 1234567891011#include &quot;kernel/types.h&quot;#include...</div></div></div></a><a class="pagination-related" href="/2025/09/20/6-S081-Lab3-page-tables/" title="6.S081_Lab3_page tables"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-20</div><div class="info-item-2">6.S081_Lab3_page tables</div></div><div class="info-2"><div class="info-item-1">6.S081_Lab3_page tables 写在前面 如果一行代码都还没有写，不知道完全要在哪里写，写什么东西，说明是对xv6的相关机制不懂，继续反复阅读xv6book 如果是写了一些代码，但是运行不起来，或者运行情况与预期不符，可以尝试询问AI或者用gdb逐行调试 如果已经花费了超额时间（例如easy题目仅做题时间超过1.5h），可以尝试阅读别人的源码，但是一定不要边看边写，要彻底看懂后自己完整的敲出来 Lab3地址 课程首页 1.Speed up system calls 要求：通过在内核与用户空间之间共享一个只读内存页来加速getpid()系统调用，具体做法是在创建进程时分配一个物理页、存入PID，然后将其以只读方式映射到用户虚拟地址USYSCALL，并在进程退出时释放它，从而让用户程序可以直接从内存读取PID，避免陷入内核。 这个 task 的难点在于，你应该把 map page 这段代码放在哪里最合适？Lab 文档里说的是 When each process is created，具体是什么时候呢？是放在 fork 的地方，还是放在 allocproc...</div></div></div></a><a class="pagination-related" href="/2025/09/13/6-S081-Lab2-System-calls/" title="6.S081_Lab2_System calls"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-13</div><div class="info-item-2">6.S081_Lab2_System calls</div></div><div class="info-2"><div class="info-item-1">6.S081_Lab2_System calls 写在前面 如果一行代码都还没有写，不知道完全要在哪里写，写什么东西，说明是对xv6的相关机制不懂，继续反复阅读xv6book 如果是写了一些代码，但是运行不起来，或者运行情况与预期不符，可以尝试询问AI或者用gdb逐行调试 如果已经花费了超额时间（例如easy题目仅做题时间超过1.5h），可以尝试阅读别人的源码，但是一定不要边看边写，要彻底看懂后自己完整的敲出来 Lab2地址 课程首页 0.Makefile 每个任务完成之后需要在Makefile中添加对应的信息才能运行 在UPROGS项下添加以下内容： 12$U/_trace\$U/_sysinfotest\ 1.System call tracing 要求：trace [tracing_mask] [command] 要求当调用了给定的tracing mask所对应的system call时，打印输出调用该system call的进程PID、system call的名称、system call的返回值。已经给出了user...</div></div></div></a><a class="pagination-related" href="/2025/09/27/6-S081-Lab4-Traps/" title="6.S081_Lab4_Traps"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-27</div><div class="info-item-2">6.S081_Lab4_Traps</div></div><div class="info-2"><div class="info-item-1">6.S081_Lab4_Traps 写在前面 如果一行代码都还没有写，不知道完全要在哪里写，写什么东西，说明是对xv6的相关机制不懂，继续反复阅读xv6book 如果是写了一些代码，但是运行不起来，或者运行情况与预期不符，可以尝试询问AI或者用gdb逐行调试 如果已经花费了超额时间（例如easy题目仅做题时间超过1.5h），可以尝试阅读别人的源码，但是一定不要边看边写，要彻底看懂后自己完整的敲出来 Lab4地址 课程首页 1.RISC-V assembly 要求：使用make fs.img编译，得到user/call.asm文件，通过阅读call.asm，了解g、f和main函数，并回答以下问题   Which registers contain arguments to functions? For example, which register holds 13 in main’s call to printf? a1 里存 12（第一个参数），a2 里存 13（第二个参数），a1、a2 包含函数参数。    Where is the call to function f...</div></div></div></a><a class="pagination-related" href="/2025/10/18/6-S081-Lab5-Copy-on-write-fork/" title="6.S081_Lab5_Copy-on-write fork"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-18</div><div class="info-item-2">6.S081_Lab5_Copy-on-write fork</div></div><div class="info-2"><div class="info-item-1">6.S081_Lab5_Copy-on-write fork 写在前面 如果一行代码都还没有写，不知道完全要在哪里写，写什么东西，说明是对xv6的相关机制不懂，继续反复阅读xv6book 如果是写了一些代码，但是运行不起来，或者运行情况与预期不符，可以尝试询问AI或者用gdb逐行调试 如果已经花费了超额时间（例如easy题目仅做题时间超过1.5h），可以尝试阅读别人的源码，但是一定不要边看边写，要彻底看懂后自己完整的敲出来 页面引用计数（Page Refcount） 这部分的代码都修改于 kalloc.c。 在 Linux 内核中，有 struct page 数据结构来对应每一个 page 的 metadata。在 Xv6 中，我定义了一个 _refcount 数组，来表示每个 page 的引用计数，引用计数为 0 表示 page 可以被释放。这里我用了一个锁来保护 _refcount 字段 123#define PAGE_IDX(pa) (((uint64)pa - (uint64)end) &gt;&gt; PGSHIFT)static int...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">lzx</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">22</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Taffy128"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Taffy128" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:yyangguangnanhai9@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">6.S081_Lab10_Mmap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lab10"><span class="toc-number">1.2.</span> <span class="toc-text">Lab10</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.1.</span> <span class="toc-text">核心数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-syscall"><span class="toc-number">1.2.2.</span> <span class="toc-text">添加 syscall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VMA-%E7%9A%84%E5%88%86%E9%85%8D%E4%B8%8E%E9%87%8A%E6%94%BE"><span class="toc-number">1.2.3.</span> <span class="toc-text">VMA 的分配与释放</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-mmap-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.4.</span> <span class="toc-text">实现 mmap 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Page-fault-%E5%A4%84%E7%90%86"><span class="toc-number">1.2.5.</span> <span class="toc-text">Page fault 处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-munmap-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.6.</span> <span class="toc-text">实现 munmap 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%86%99%E5%9B%9E-writeback-%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.7.</span> <span class="toc-text">文件写回 writeback 实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exit-%E9%83%A8%E5%88%86%E5%A4%84%E7%90%86"><span class="toc-number">1.2.8.</span> <span class="toc-text">Exit 部分处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fork-%E9%83%A8%E5%88%86%E5%A4%84%E7%90%86"><span class="toc-number">1.2.9.</span> <span class="toc-text">Fork 部分处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.</span> <span class="toc-text">完整代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.4.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/28/6-S081-Lecture-Notes/" title="6.S081_Lecture Notes">6.S081_Lecture Notes</a><time datetime="2025-11-28T10:45:48.815Z" title="发表于 2025-11-28 18:45:48">2025-11-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/28/6-S081-Lab10-Mmap/" title="6.S081_Lab10_Mmap">6.S081_Lab10_Mmap</a><time datetime="2025-11-28T10:43:14.371Z" title="发表于 2025-11-28 18:43:14">2025-11-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/26/6-S081-Lab9-File-system/" title="6.S081_Lab9_File system">6.S081_Lab9_File system</a><time datetime="2025-11-26T12:18:38.190Z" title="发表于 2025-11-26 20:18:38">2025-11-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/24/6-S081-Lab8-locks/" title="6.S081_Lab8_locks">6.S081_Lab8_locks</a><time datetime="2025-11-24T14:30:04.484Z" title="发表于 2025-11-24 22:30:04">2025-11-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/23/6-S081-Lab7-networking/" title="6.S081_Lab7_networking">6.S081_Lab7_networking</a><time datetime="2025-11-23T07:42:59.202Z" title="发表于 2025-11-23 15:42:59">2025-11-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By lzx</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div><div class="footer_custom_text">Hi, welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>